#!/bin/bash

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit
fi

model="$(tr -d '\0' </proc/device-tree/model)"
echo "Model: ${model}"

if [[ "${model}" != *"Raspberry Pi 4"* ]]; then
  echo "Not Raspberry Pi 4 - exiting..."
  return 0
fi

if [[ "$(/usr/bin/pt-host)" != "pi-top [4]" ]]; then
  echo "No pi-top [4] detected - exiting..."
  return 0
fi

output="$(rpi-eeprom-update)"

bootloader_current="$(echo "${output}" | ag "CURRENT" | head -n1 | awk '{print $NF}' | sed 's/[()]//g')"
bootloader_latest="$(echo "${output}" | ag "LATEST" | head -n1 | awk '{print $NF}' | sed 's/[()]//g')"

vl805_current="$(echo "${output}" | ag "CURRENT" | tail -n1)"
vl805_latest="$(echo "${output}" | ag "LATEST" | tail -n1)"

echo "BOOTLOADER"
echo "CURRENT: ${bootloader_current}"
echo " LATEST: ${bootloader_latest}"

echo ""

echo "VL805"
echo "CURRENT: ${vl805_current}"
echo " LATEST: ${vl805_latest}"

verifyCurrentEEPROMConfig() {
  echo "No bootloader updates available - checking for valid EEPROM config"

  if [ -f /etc/default/rpi-eeprom-update ]; then
    # shellcheck disable=SC1091
    . /etc/default/rpi-eeprom-update
  fi

  echo "Config hook: ${EEPROM_CONFIG_HOOK}"

  if [ -x "${EEPROM_CONFIG_HOOK}" ]; then

    echo "Executable config hook found"

    orig_bootloader_config="$(/opt/vc/bin/vcgencmd bootloader_config)"

    mod_bootloader_config="$(echo "${orig_bootloader_config}" | ${EEPROM_CONFIG_HOOK})"

    if [[ "${mod_bootloader_config}" == "${orig_bootloader_config}" ]]; then

      echo "Raspberry Pi bootloader configuration is correct for current pi-top device"
      echo "No action required..."

    else

      echo "Raspberry Pi bootloader configuration is incorrect for current pi-top device"

      echo
      diff --color='always' --suppress-common-lines <(echo "${orig_bootloader_config}") <(echo "${mod_bootloader_config}")
      echo

      return 1

    fi

  else

    echo "No executable config hook found."

  fi

  return 0
}

runUpdate=0

if [[ "${vl805_current}" == "${vl805_latest}" ]]; then

  if [[ "${bootloader_current}" -gt "${bootloader_latest}" ]]; then

    echo "Raspberry Pi version is ahead of latest on OS."

    if ! verifyCurrentEEPROMConfig; then

      echo "Notifying user of situation..."

      # TODO: handle wording

      DISPLAY=:0 pt-notify-send -t 0 \
        "--action=Apply patch with downgrade and reboot:/usr/lib/rpi-eeprom-update/pt-force-rpi-eeprom-install" \
        "Invalid Raspberry Pi EEPROM configuration" \
        "A patch to the Raspberry Pi EEPROM is required for full functionality.
EEPROM version on Raspberry Pi is not available, so downgrade is required"

    fi

    # Show different message to user? Offer a different solution

  elif [[ "${bootloader_current}" -eq "${bootloader_latest}" ]]; then

    if ! verifyCurrentEEPROMConfig; then

      echo "Requesting user to apply patch and reboot..."

      # TODO: handle wording

      DISPLAY=:0 pt-notify-send -t 0 \
        "--action=Apply patch and reboot:/usr/lib/rpi-eeprom-update/pt-force-rpi-eeprom-install" \
        "Invalid Raspberry Pi EEPROM configuration" \
        "A patch to the Raspberry Pi EEPROM is required for full functionality."

    fi

  else

    runUpdate=1

  fi

else

  runUpdate=1

fi

if [[ "${runUpdate}" -eq 1 ]]; then

  echo "Firmware updates available - running 'rpi-eeprom-update -a'..."
  rpi-eeprom-update -a

fi
